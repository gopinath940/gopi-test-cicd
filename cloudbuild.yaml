steps:
- name: "gcr.io/cloud-builders/gcloud"
  entrypoint: bash
  args:
    - "-c"
    - |
      echo "ğŸ”‘ Fetching SSH Key from Secret Manager..."
      gcloud secrets versions access latest --secret=vm-ssh-key > /root/.ssh/id_rsa

      echo "ğŸ“ Configuring SSH..."
      mkdir -p /root/.ssh
      chmod 600 /root/.ssh/id_rsa

      cat <<EOF > /root/.ssh/config
      Host prodvm
        HostName <VM_PUBLIC_IP>
        User gopi
        IdentityFile /root/.ssh/id_rsa
        StrictHostKeyChecking no
      EOF

      echo "ğŸ“¤ Copying updated index.html to VM..."
      scp -i /root/.ssh/id_rsa -o StrictHostKeyChecking=no ./index.html gopi@<VM_PUBLIC_IP>:/var/www/html/index.html

      echo "ğŸ”„ Restarting Apache..."
      ssh -i /root/.ssh/id_rsa -o StrictHostKeyChecking=no gopi@<VM_PUBLIC_IP> "sudo systemctl restart apache2"

      echo "ğŸ‰ Deployment Completed Successfully!"

